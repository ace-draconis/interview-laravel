name: Laravel
"on":
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
jobs:
  laravel-tests:
    runs-on: ubuntu-latest
    services:
      db:
        image: "mysql:5.7"
        env:
          MYSQL_ROOT_USER: root
          MYSQL_ROOT_PASSWORD: ZkdiwZe38Gsd
          MYSQL_USER: toyeight
          MYSQL_PASSWORD: 87sjbS2dBmzd
          MYSQL_DATABASE: school_db
          MYSQL_HOST: db
        ports:
          - "33306:3306"
        options: >-
          --health-cmd="mysqladmin ping" --health-interval=10s
          --health-timeout=5s --health-retries=3
    steps:
      - uses: shivammathur/setup-php@15c43e89cdef867065b0213be354c2841860869e
        with:
          php-version: "8.1"
      - uses: actions/checkout@v3
      - name: Copy .env
        run: cp .env.example .env
        working-directory: src/
      - name: Install Dependencies
        run: >-
          composer install -q --no-ansi --no-interaction --no-scripts
          --no-progress --prefer-dist
        working-directory: src/
      - name: Generate key
        run: "php artisan key:generate"
        working-directory: src/
      - name: Directory Permissions
        run: chmod -R 777 storage bootstrap/cache
        working-directory: src/
      - name: Migrate DB
        run: |
          php artisan migrate --force
          php artisan db:seed
        working-directory: src/
      - name: Psalm Security Scan
        uses: >-
          psalm/psalm-github-security-scan@f3e6fd9432bc3e44aec078572677ce9d2ef9c287
        with:
          entryPoint: ./src
      - name: Upload Security Analysis results to GitHub
        uses: github/codeql-action/upload-sarif@v2
        with:
          sarif_file: results.sarif
